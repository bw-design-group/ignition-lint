# PyPI Publishing Implementation Plan - v0.3.0

**Status:** Ready for Implementation
**Target:** First PyPI release as v0.3.0
**Key Changes:** Python 3.13 support, automated release workflow, remove ignition-api-stubs

---

## Quick Navigation

- [Phase 1: Core Package Updates](#phase-1-core-package-updates) â† **Start here**
- [Phase 2: Workflow Consolidation](#phase-2-workflow-consolidation)
- [Phase 3: Release Automation](#phase-3-release-automation)
- [Phase 4: Documentation](#phase-4-documentation)
- [Phase 5: PyPI Setup (User Action)](#phase-5-pypi-setup-user-action)
- [Phase 6: Testing & Validation](#phase-6-testing--validation)
- [Phase 7: Production Release](#phase-7-production-release)

---

## Implementation Overview

### Prerequisites
- âœ… Git repository with dev/main branches
- âœ… Poetry installed and configured
- âœ… Existing test suite passing
- âœ… Current version: 0.2.10

### Goals
- âœ… Enable Python 3.13 support
- âœ… Remove unused ignition-api-stubs dependency
- âœ… Automate release preparation via RC tags
- âœ… Publish to PyPI as v0.3.0
- âœ… Establish sustainable release workflow

### Phase Dependencies

```
Phase 1 (Core) â”€â”€â”
                 â”œâ”€â†’ Phase 6 (Testing) â”€â”€â†’ Phase 7 (Production)
Phase 2 (Workflows) â”€â”€â”¤                     â†‘
                 â”‚                          â”‚
Phase 3 (Automation) â”€â”¤                     â”‚
                 â”‚                          â”‚
Phase 4 (Docs) â”€â”€â”¤                          â”‚
                 â”‚                          â”‚
Phase 5 (PyPI Setup - USER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Phases 1-4 can be done in parallel or any order**
**Phase 5 requires user action (account creation, tokens)**
**Phases 6-7 require completion of 1-5**

---

## Phase 1: Core Package Updates

**Time Estimate:** 10-15 minutes
**Dependencies:** None
**Can be done in parallel with:** Phases 2, 3, 4

### Objective
Update package metadata and dependencies to support Python 3.13 and remove unused dependencies.

### Tasks

#### 1.1: Update pyproject.toml

**File:** `pyproject.toml`

**Changes:**
```toml
[tool.poetry]
name = "ignition-lint"
version = "0.3.0"  # â† Bump from 0.1.0

# Add keywords
keywords = [
    "ignition",
    "perspective",
    "linting",
    "json",
    "scada",
    "quality-assurance",
    "static-analysis"
]

# Add classifiers
classifiers = [
    "Development Status :: 4 - Beta",
    "Environment :: Console",
    "Intended Audience :: Developers",
    "Intended Audience :: Manufacturing",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",  # â† Add 3.13
    "Topic :: Software Development :: Quality Assurance",
    "Topic :: Software Development :: Testing",
    "Topic :: Text Processing :: Markup :: JSON",
    "Typing :: Typed"
]

[tool.poetry.dependencies]
python = ">=3.10,<3.14"  # â† Update from <3.13 to <3.14
pylint = "*"
# ignition-api-stubs = "^8.1.48.post1"  # â† DELETE THIS LINE

[tool.poetry.group.dev.dependencies]
yapf = "*"
pre-commit = "^4.2.0"  # â† Move from dependencies to dev
ignition-api-stubs = "^8.3.3"  # â† Add here (optional, for dev)
```

**Why these changes:**
- âœ… **Version 0.3.0**: Marks PyPI availability as new feature
- âœ… **Python 3.13**: Enables latest Python version support
- âœ… **Remove ignition-api-stubs**: Not used at runtime (verified)
- âœ… **Keywords/Classifiers**: Improves PyPI discoverability
- âœ… **pre-commit to dev**: Cleaner dependency separation

#### 1.2: Update poetry.lock

```bash
poetry lock --no-update
```

This regenerates the lock file with the new constraints.

#### 1.3: Verify package still works

```bash
# Test imports
poetry run python -c "from ignition_lint.linter import LintEngine; print('âœ“ Imports work')"

# Test CLI
poetry run python -m ignition_lint --help

# Run tests
cd tests
poetry run python test_runner.py --run-unit
cd ..
```

**Expected:** All tests pass without ignition-api-stubs.

**Why it works:** PylintScriptRule creates `system = None` stub, so pylint doesn't complain about undefined Ignition API calls.

### Verification Checklist
- [ ] pyproject.toml updated with v0.3.0
- [ ] Python version is `>=3.10,<3.14`
- [ ] ignition-api-stubs removed from dependencies
- [ ] pre-commit moved to dev dependencies
- [ ] Keywords and classifiers added
- [ ] poetry.lock regenerated
- [ ] Package imports successfully
- [ ] CLI works
- [ ] Tests pass

### Rollback
If issues arise:
```bash
git checkout pyproject.toml poetry.lock
poetry install
```

---

## Phase 2: Workflow Consolidation

**Time Estimate:** 15-20 minutes
**Dependencies:** None
**Can be done in parallel with:** Phases 1, 3, 4

### Objective
Consolidate redundant workflows, optimize CI triggers, and add Python 3.13 testing.

### Tasks

#### 2.1: Rename and Update Main CI Workflow

**Action:** Rename `.github/workflows/ci.yml` â†’ `.github/workflows/ci-pipeline.yml`

```bash
git mv .github/workflows/ci.yml .github/workflows/ci-pipeline.yml
```

**Then update the file:**

**File:** `.github/workflows/ci-pipeline.yml`

**Changes:**
```yaml
name: CI Pipeline

on:
  pull_request:
    branches: [ main, dev ]  # â† Changed: only on PRs, not pushes
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # â† Smart matrix: 3.13 for dev PRs, all versions for main PRs
        python-version: >-
          ${{
            github.base_ref == 'main' &&
            fromJSON('["3.10", "3.11", "3.12", "3.13"]') ||
            fromJSON('["3.13"]')
          }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install

      - name: Run linting with pylint
        run: poetry run pylint --rcfile=.config/.pylintrc ignition_lint/

      - name: Run unit tests
        run: |
          cd tests
          poetry run python test_runner.py --run-unit

      - name: Run integration tests
        run: |
          cd tests
          poetry run python test_runner.py --run-integration

      - name: Test CLI functionality
        run: |
          poetry run python -m ignition_lint --help
          poetry run python -m ignition_lint --config .github/workflows/.ignition-lint-ci.json --files tests/cases/PascalCase/view.json --ignore-warnings

  build:
    runs-on: ubuntu-latest
    needs: test
    # â† Only build on PRs to main (release prep)
    if: github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"  # â† Updated from 3.11

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build package
        run: poetry build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
```

**Key improvements:**
- âœ… Triggers only on PRs (not every push)
- âœ… Tests Python 3.13 for dev PRs (fast)
- âœ… Tests all versions (3.10-3.13) for main PRs (thorough)
- âœ… Builds only for release PRs (conditional)
- âœ… **75% reduction in CI runs**

#### 2.2: Delete Redundant Workflows

```bash
git rm .github/workflows/unittest.yml
git rm .github/workflows/integration-test.yml
```

**Why delete:**
- âŒ unittest.yml runs on EVERY push (wasteful)
- âŒ Has broken trigger (`types: [closed]` - runs AFTER merge!)
- âŒ Uses Python 3.11 (outdated)
- âŒ integration-test.yml runs on EVERY push
- âŒ Uses Python 3.12 (outdated)
- âœ… ci-pipeline.yml already runs both unit + integration tests

**Compute savings:**
- Before: 3 workflows Ã— every push = ~8 min
- After: 1 workflow Ã— PRs only = ~2 min
- **75% reduction!**

### Verification Checklist
- [ ] ci.yml renamed to ci-pipeline.yml
- [ ] Triggers updated (PRs only, not pushes)
- [ ] Python matrix updated (3.13 for dev, all for main)
- [ ] Build step conditional (main PRs only)
- [ ] unittest.yml deleted
- [ ] integration-test.yml deleted

### Testing
After committing:
- Create test PR to dev branch
- Verify only Python 3.13 runs
- Create test PR to main branch
- Verify all Python versions run

---

## Phase 3: Release Automation

**Time Estimate:** 20-30 minutes
**Dependencies:** None
**Can be done in parallel with:** Phases 1, 2, 4

### Objective
Create automated workflows for release preparation and PyPI publishing.

### Tasks

#### 3.1: Create Release Preparation Workflow

**File:** `.github/workflows/prepare-release.yml` (NEW)

This workflow triggers when you push an RC tag (e.g., `v0.3.0-RC1`) and automatically:
1. Extracts version from tag
2. Updates pyproject.toml version
3. Transforms CHANGELOG.md (Unreleased â†’ versioned)
4. Creates PR from dev â†’ main

**Content:**
```yaml
name: Prepare Release from RC Tag

on:
  push:
    tags:
      - 'v*-RC*'  # Triggers on v0.3.0-RC1, v0.3.1-RC2, etc.

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG%%-RC*}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rc_tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Preparing release for version: $VERSION"

      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Get last release tag
        id: last_release
        run: |
          LAST_TAG=$(git tag --list 'v*' --sort=-version:refname | grep -v 'RC' | head -n1)
          LAST_VERSION="${LAST_TAG#v}"
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "last_version=$LAST_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Last release: $LAST_TAG"

      - name: Update pyproject.toml version
        run: |
          poetry version "${{ steps.version.outputs.version }}"
          echo "âœ… Updated pyproject.toml to version ${{ steps.version.outputs.version }}"

      - name: Update CHANGELOG.md (idempotent)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_VERSION="${{ steps.last_release.outputs.last_version }}"
          DATE=$(date +%Y-%m-%d)

          echo "ðŸ”„ Updating CHANGELOG.md for version ${VERSION}..."

          # Check if this version already exists (e.g., from previous RC run)
          if grep -q "## \[${VERSION}\]" CHANGELOG.md; then
            echo "âš ï¸  Version ${VERSION} already exists in CHANGELOG"
            echo "   Updating date and ensuring [Unreleased] section exists..."

            # Update the date on existing version
            sed -i "s/## \[${VERSION}\] - .*/## [${VERSION}] - ${DATE}/" CHANGELOG.md

            # Ensure [Unreleased] section exists at top
            if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
              sed -i "/# Changelog/a\\
\\
## [Unreleased]" CHANGELOG.md
              echo "   Added missing [Unreleased] section"
            fi
          else
            echo "âœ¨ First run for ${VERSION}, creating new section..."

            # Ensure [Unreleased] section exists (defensive)
            if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
              sed -i "/# Changelog/a\\
\\
## [Unreleased]" CHANGELOG.md
            fi

            # Replace [Unreleased] with versioned heading
            sed -i "s/## \[Unreleased\]/## [${VERSION}] - ${DATE}/" CHANGELOG.md

            # Add new [Unreleased] section at top
            sed -i "/# Changelog/a\\
\\
## [Unreleased]" CHANGELOG.md
          fi

          # Update comparison links (idempotent)
          sed -i "/^\[${VERSION}\]:/d" CHANGELOG.md
          echo "[${VERSION}]: https://github.com/design-group/ignition-lint/compare/v${LAST_VERSION}...v${VERSION}" >> CHANGELOG.md
          sed -i "s|\[Unreleased\]:.*|[Unreleased]: https://github.com/design-group/ignition-lint/compare/v${VERSION}...HEAD|" CHANGELOG.md

          echo "âœ… CHANGELOG.md updated successfully"

      - name: Commit changes to dev
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add pyproject.toml CHANGELOG.md
          git commit -m "chore: Prepare release v${{ steps.version.outputs.version }}

          Auto-generated from RC tag ${{ steps.version.outputs.rc_tag }}

          - Updated version in pyproject.toml
          - Updated CHANGELOG.md with release date"

          git push origin dev

      - name: Create or Update Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"

          # Extract changelog section
          CHANGELOG_SECTION=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d')
          COMMIT_LIST=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -30)

          # Create PR body
          cat > /tmp/pr_body.md << EOF
          ## Release v${VERSION}

          Auto-generated from RC tag \`${{ steps.version.outputs.rc_tag }}\`.

          ### Changes in this release

          ${CHANGELOG_SECTION}

          ### Commits included (since ${LAST_TAG})

          ${COMMIT_LIST}

          ---

          **Next steps:**
          1. Review the changelog above
          2. Edit CHANGELOG.md if needed
          3. Approve and merge this PR
          4. Tag main: \`git tag v${VERSION} && git push origin v${VERSION}\`
          5. PyPI publish will trigger automatically
          EOF

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "âš ï¸  Updating existing PR #${EXISTING_PR}"
            gh pr edit "$EXISTING_PR" --title "Release v${VERSION}" --body-file /tmp/pr_body.md
          else
            echo "âœ¨ Creating new PR"
            gh pr create --base main --head dev --title "Release v${VERSION}" --body-file /tmp/pr_body.md --label "release"
          fi

      - name: Summary
        run: |
          echo "âœ… Release preparation complete!"
          echo "   Version: ${{ steps.version.outputs.version }}"
          echo "   RC Tag: ${{ steps.version.outputs.rc_tag }}"
```

**Features:**
- âœ… Idempotent (safe to run multiple RC attempts)
- âœ… Auto-updates existing PRs if found
- âœ… Extracts version from tag
- âœ… Updates pyproject.toml and CHANGELOG.md
- âœ… Creates PR with full context

#### 3.2: Create PyPI Publishing Workflow

**File:** `.github/workflows/publish.yml` (NEW)

This workflow triggers when you push a production tag (e.g., `v0.3.0`) and automatically publishes to PyPI.

**Content:**
```yaml
name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
      - '!v*-RC*'  # Exclude RC tags
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build package
        run: poetry build

      - name: Publish to Test PyPI
        if: github.event.inputs.test_pypi == 'true'
        env:
          POETRY_PYPI_TOKEN_TESTPYPI: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          poetry config repositories.testpypi https://test.pypi.org/legacy/
          poetry publish -r testpypi

      - name: Publish to PyPI
        if: github.event_name == 'push' && github.event.inputs.test_pypi != 'true'
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_API_TOKEN }}
        run: poetry publish
```

**Features:**
- âœ… Triggers on production tags (v0.3.0, v0.3.1, etc.)
- âœ… Excludes RC tags (v0.3.0-RC1)
- âœ… Manual trigger option for Test PyPI
- âœ… Uses Poetry for publishing

### Verification Checklist
- [ ] prepare-release.yml created
- [ ] publish.yml created
- [ ] Both workflows have correct syntax
- [ ] RC tag pattern matches: v*-RC*
- [ ] Production tag pattern matches: v* (excludes RC)

### Testing (After Phase 5 - PyPI Setup)
- Tag with RC: `git tag v0.3.0-RC1 && git push origin v0.3.0-RC1`
- Verify prepare-release workflow runs
- Check that PR is created
- Verify CHANGELOG and pyproject.toml updated

---

## Phase 4: Documentation

**Time Estimate:** 15-20 minutes
**Dependencies:** None
**Can be done in parallel with:** Phases 1, 2, 3

### Objective
Document the release process for future maintainers.

### Tasks

#### 4.1: Create RELEASING.md

**File:** `RELEASING.md` (NEW at repository root)

**Content:** (See full RELEASING.md in appendix)

Key sections:
- Overview of release workflow
- Prerequisites
- Step-by-step release process
- Troubleshooting guide
- Rollback procedures

#### 4.2: Update CLAUDE.md

**File:** `CLAUDE.md`

**Add section before "## Quick Reference":**

```markdown
## Release Process

### Publishing to PyPI

For detailed instructions on releasing new versions, see [RELEASING.md](RELEASING.md).

**Quick workflow:**
1. Ensure all features merged to `dev`
2. Update CHANGELOG.md under `## [Unreleased]`
3. Tag RC: `git tag v0.3.1-RC1 && git push origin v0.3.1-RC1`
4. ðŸ¤– Automation creates PR (dev â†’ main)
5. Review and merge PR
6. Tag production: `git tag v0.3.1 && git push origin v0.3.1`
7. ðŸ¤– PyPI publish triggers automatically

**Testing releases:**
Use manual workflow dispatch in GitHub Actions for Test PyPI validation.
```

### Verification Checklist
- [ ] RELEASING.md created with complete workflow
- [ ] CLAUDE.md updated with release section
- [ ] Documentation references correct workflow files
- [ ] Links between documents work

---

## Phase 5: PyPI Setup (User Action)

**Time Estimate:** 15-20 minutes
**Dependencies:** Phases 1-4 complete (code ready to publish)
**Requires:** User action (account creation, token generation)

### Objective
Set up PyPI accounts and configure GitHub secrets for automated publishing.

### Tasks

#### 5.1: Create PyPI Accounts

**Test PyPI (Recommended for testing):**
1. Go to https://test.pypi.org/account/register/
2. Create account with your email
3. Verify email address
4. Enable 2FA (recommended)

**Production PyPI:**
1. Go to https://pypi.org/account/register/
2. Create account with your email
3. Verify email address
4. Enable 2FA (recommended)

#### 5.2: Generate API Tokens

**Test PyPI Token:**
1. Login to https://test.pypi.org
2. Go to Account Settings â†’ API tokens
3. Click "Add API token"
   - Token name: `ignition-lint-github-actions-test`
   - Scope: "Entire account" (will restrict after first publish)
4. Copy token (shown only once!)
5. Save securely

**Production PyPI Token:**
1. Login to https://pypi.org
2. Go to Account Settings â†’ API tokens
3. Click "Add API token"
   - Token name: `ignition-lint-github-actions`
   - Scope: "Entire account" (will restrict after first publish)
4. Copy token (shown only once!)
5. Save securely

**Important:** Keep these tokens secure. They will NOT be shown again.

#### 5.3: Add Tokens to GitHub Secrets

1. Go to repository: https://github.com/design-group/ignition-lint
2. Settings â†’ Secrets and variables â†’ Actions
3. Click "New repository secret"

**Add two secrets:**

**Secret 1:**
- Name: `TEST_PYPI_API_TOKEN`
- Value: (paste Test PyPI token)

**Secret 2:**
- Name: `PYPI_API_TOKEN`
- Value: (paste production PyPI token)

### Verification Checklist
- [ ] Test PyPI account created
- [ ] Production PyPI account created
- [ ] Test PyPI token generated
- [ ] Production PyPI token generated
- [ ] TEST_PYPI_API_TOKEN added to GitHub secrets
- [ ] PYPI_API_TOKEN added to GitHub secrets

### Security Notes
- âœ… Tokens stored only in GitHub secrets (encrypted)
- âœ… Never commit tokens to repository
- âœ… 2FA enabled on PyPI accounts
- âœ… Will restrict token scope after first publish

---

## Phase 6: Testing & Validation

**Time Estimate:** 20-30 minutes
**Dependencies:** Phases 1-5 complete
**Purpose:** Validate everything works before production

### Objective
Test the complete workflow using Test PyPI before publishing to production.

### Tasks

#### 6.1: Local Build Test

```bash
# Clean any previous builds
rm -rf dist/

# Build with Poetry
poetry build

# Verify build artifacts
ls -lh dist/
# Should see:
# - ignition_lint-0.3.0-py3-none-any.whl
# - ignition_lint-0.3.0.tar.gz

# Inspect wheel contents
unzip -l dist/ignition_lint-0.3.0-py3-none-any.whl | grep -E "(ignition_lint|\.config)"
# Verify:
# - ignition_lint/ package present
# - .config/.pylintrc included
# - No test files or debug scripts
```

**Expected:** Clean build with correct version (0.3.0).

#### 6.2: Test PyPI Publish (Manual)

```bash
# Configure Test PyPI repository
poetry config repositories.testpypi https://test.pypi.org/legacy/

# Publish to Test PyPI (prompts for token)
poetry publish -r testpypi
# Or use token from secret:
# POETRY_PYPI_TOKEN_TESTPYPI=<token> poetry publish -r testpypi
```

**Expected:** Successful upload to Test PyPI.

#### 6.3: Test Installation from Test PyPI

```bash
# Create fresh test environment
python3.13 -m venv /tmp/test-ignition-lint
source /tmp/test-ignition-lint/bin/activate

# Install from Test PyPI
pip install --index-url https://test.pypi.org/simple/ \
    --extra-index-url https://pypi.org/simple/ \
    ignition-lint==0.3.0

# Verify CLI works
ignition-lint --version
# Should output: ignition-lint 0.3.0

ignition-lint --help
# Should show full help

# Test on real file
cd /Users/alex.spyksma/dev/tools/ignition-lint
ignition-lint --config rule_config.json --files tests/cases/PascalCase/view.json

# Cleanup
deactivate
rm -rf /tmp/test-ignition-lint
```

**Expected:** Package installs and works correctly.

**Note:** `--extra-index-url` is needed because Test PyPI doesn't have all dependencies (like pylint). This tells pip to get ignition-lint from Test PyPI but dependencies from production PyPI.

#### 6.4: Test RC Workflow

```bash
# Ensure CHANGELOG.md has content under [Unreleased]
vim CHANGELOG.md
# Add some test entries if needed

# Commit any changes
git add CHANGELOG.md
git commit -m "test: Update changelog for testing"
git push origin dev

# Tag with RC
git tag v0.3.0-RC1 -m "Test RC for v0.3.0"
git push origin v0.3.0-RC1
```

**Then verify:**
1. Go to Actions â†’ "Prepare Release from RC Tag"
2. Workflow should be running
3. Wait for completion (~1-2 min)
4. Check:
   - [ ] Workflow succeeded
   - [ ] pyproject.toml updated on dev branch
   - [ ] CHANGELOG.md transformed correctly
   - [ ] PR created (dev â†’ main)
   - [ ] PR description has changelog and commits

**Review the PR:**
- Check version is correct (0.3.0)
- Check CHANGELOG date is today
- Check [Unreleased] section exists again
- Check comparison links updated

If needed to test RC2:
```bash
# Close the PR (don't merge)
gh pr close <PR-NUMBER>

# Make changes to CHANGELOG if needed
vim CHANGELOG.md
git add CHANGELOG.md
git commit -m "test: Update changelog"
git push origin dev

# Tag RC2
git tag v0.3.0-RC2 -m "Second RC for v0.3.0"
git push origin v0.3.0-RC2
```

**Expected:** Workflow updates existing sections idempotently, creates new PR or updates existing one.

### Verification Checklist
- [ ] Local build succeeds
- [ ] Build artifacts look correct
- [ ] Manual Test PyPI publish works
- [ ] Package installs from Test PyPI
- [ ] CLI functions correctly
- [ ] RC tag triggers prepare-release workflow
- [ ] PR created with correct content
- [ ] Multiple RC attempts work (idempotent)

### Common Issues

**Issue:** Poetry publish fails with authentication error
**Fix:** Verify `TEST_PYPI_API_TOKEN` is set correctly in GitHub secrets, or provide token manually for local testing

**Issue:** pip install from Test PyPI fails with dependency errors
**Fix:** Use `--extra-index-url https://pypi.org/simple/` to allow dependencies from production PyPI

**Issue:** RC workflow doesn't trigger
**Fix:** Verify tag pattern matches `v*-RC*` (e.g., `v0.3.0-RC1` not `0.3.0-RC1`)

---

## Phase 7: Production Release

**Time Estimate:** 10-15 minutes
**Dependencies:** Phase 6 complete and successful
**This is it!** ðŸš€

### Objective
Publish v0.3.0 to production PyPI and establish the package.

### Tasks

#### 7.1: Final Pre-Release Checks

```bash
# Verify all PRs merged to dev
git checkout dev
git pull origin dev

# Verify tests pass
cd tests
poetry run python test_runner.py --run-all
cd ..

# Verify CHANGELOG.md is up to date
cat CHANGELOG.md | head -30
# Should have [Unreleased] section and recent release entries

# Verify version in pyproject.toml
grep "^version" pyproject.toml
# Should show: version = "0.3.0" (or from RC workflow)
```

#### 7.2: Create Release PR (If not already from RC)

If you haven't used the RC workflow yet:

```bash
# Update CHANGELOG.md manually
vim CHANGELOG.md
# Change [Unreleased] to [0.3.0] - 2026-02-XX
# Add new [Unreleased] section

# Update version
poetry version 0.3.0

# Commit
git add pyproject.toml CHANGELOG.md
git commit -m "chore: Prepare release v0.3.0"
git push origin dev

# Create PR
gh pr create --base main --head dev --title "Release v0.3.0" \
  --body "First PyPI release with Python 3.13 support"
```

Or if RC workflow was used:
- The PR already exists from Phase 6.4
- Review and approve it

#### 7.3: Merge Release PR

```bash
# Review PR one final time
gh pr view <PR-NUMBER>

# Merge (or use GitHub UI)
gh pr merge <PR-NUMBER> --squash  # or --merge or --rebase

# Pull latest main
git checkout main
git pull origin main
```

#### 7.4: Tag Production Release

```bash
# Verify you're on main with latest code
git checkout main
git pull origin main

# Verify version is correct
grep "^version" pyproject.toml

# Create annotated tag
git tag -a v0.3.0 -m "Release v0.3.0 - First PyPI publication

Features:
- Python 3.13 support
- Removed unused ignition-api-stubs dependency
- Automated release workflow
- Published to PyPI"

# Push tag (this triggers PyPI publish workflow!)
git push origin v0.3.0
```

**Critical:** Pushing this tag triggers the publish workflow!

#### 7.5: Monitor PyPI Publish Workflow

1. Go to Actions â†’ "Publish to PyPI"
2. Watch the workflow run (~2-3 min)
3. Verify all steps succeed:
   - [ ] Checkout code
   - [ ] Set up Python 3.13
   - [ ] Install Poetry
   - [ ] Build package
   - [ ] Publish to PyPI

If any step fails, see troubleshooting section.

#### 7.6: Verify PyPI Publication

**Check PyPI listing:**
1. Visit: https://pypi.org/project/ignition-lint/
2. Verify:
   - [ ] Version 0.3.0 is listed
   - [ ] Description looks correct
   - [ ] Keywords visible
   - [ ] Classifiers show Python 3.10-3.13
   - [ ] Links work (Homepage, Repository)

**Test installation:**
```bash
# Fresh environment
python3.13 -m venv /tmp/test-prod
source /tmp/test-prod/bin/activate

# Install from production PyPI
pip install ignition-lint==0.3.0

# Verify
ignition-lint --version
# Output: ignition-lint 0.3.0

# Test functionality
cd /Users/alex.spyksma/dev/tools/ignition-lint
ignition-lint --files tests/cases/PascalCase/view.json

# Cleanup
deactivate
rm -rf /tmp/test-prod
```

**Expected:** Clean install, CLI works perfectly.

#### 7.7: Create GitHub Release (Optional but Recommended)

1. Go to https://github.com/design-group/ignition-lint/releases/new
2. Select tag: `v0.3.0`
3. Release title: `v0.3.0 - First PyPI Release`
4. Description (copy from CHANGELOG.md):
   ```markdown
   ## First PyPI Release ðŸŽ‰

   ignition-lint is now available on PyPI! Install with:
   ```bash
   pip install ignition-lint
   ```

   ### Added
   - Python 3.13 support
   - Automated release workflow via RC tags
   - PyPI distribution

   ### Changed
   - Removed unused ignition-api-stubs dependency
   - Moved pre-commit to dev dependencies
   - Optimized CI/CD workflows

   ### Links
   - PyPI: https://pypi.org/project/ignition-lint/
   - Documentation: [RELEASING.md](RELEASING.md)
   ```
5. Click "Publish release"

#### 7.8: Restrict PyPI Token Scope (Security)

Now that the package exists on PyPI, restrict the token:

1. Go to https://pypi.org â†’ Account Settings â†’ API tokens
2. Delete the account-scoped token
3. Create new project-scoped token:
   - Token name: `ignition-lint-github-actions`
   - Scope: "Project: ignition-lint" (not "Entire account")
4. Update GitHub secret:
   - Go to repository Settings â†’ Secrets
   - Edit `PYPI_API_TOKEN`
   - Paste new project-scoped token

**Why:** Limits damage if token is ever compromised.

#### 7.9: Update README Badge (Optional)

**File:** `README.md`

Add PyPI badges at the top:
```markdown
# Ignition Lint

[![PyPI version](https://badge.fury.io/py/ignition-lint.svg)](https://badge.fury.io/py/ignition-lint)
[![Python](https://img.shields.io/pypi/pyversions/ignition-lint.svg)](https://pypi.org/project/ignition-lint/)
[![License](https://img.shields.io/pypi/l/ignition-lint.svg)](https://github.com/design-group/ignition-lint/blob/main/LICENSE)

A linter for Ignition Perspective view.json files...
```

### Verification Checklist
- [ ] Release PR merged to main
- [ ] Production tag created and pushed
- [ ] Publish workflow succeeded
- [ ] Package visible on PyPI
- [ ] Version 0.3.0 listed
- [ ] Metadata correct (Python 3.13 supported)
- [ ] pip install works
- [ ] CLI functions correctly
- [ ] GitHub Release created
- [ ] PyPI token scope restricted
- [ ] README badges added (optional)

### Celebration Checklist
- [ ] ðŸŽ‰ First PyPI release complete!
- [ ] Share with team
- [ ] Update documentation
- [ ] Plan next release

---

## Troubleshooting

### Phase 1 Issues

**Problem:** Tests fail after removing ignition-api-stubs
**Diagnosis:** Check if ignition is actually imported somewhere
**Solution:**
```bash
# Search for ignition imports
grep -r "from ignition" src/ tests/
grep -r "import ignition" src/ tests/

# Should find none - if you do, that's the issue
```

**Problem:** poetry lock fails
**Solution:** Try updating Poetry first:
```bash
poetry self update
poetry lock --no-update
```

### Phase 2 Issues

**Problem:** Workflow syntax errors
**Solution:** Validate YAML syntax:
```bash
# Use yamllint or online validator
yamllint .github/workflows/ci-pipeline.yml
```

**Problem:** Matrix syntax not working
**Solution:** Ensure proper JSON formatting in `fromJSON()` calls

### Phase 5 Issues

**Problem:** Can't create PyPI token
**Solution:** Ensure 2FA is enabled on PyPI account

**Problem:** GitHub secrets not found
**Solution:** Check secrets are at repository level, not environment level

### Phase 6 Issues

**Problem:** Test PyPI publish fails with "403 Forbidden"
**Solution:** Token is incorrect or expired. Regenerate token and update secret.

**Problem:** "Package already exists" error
**Solution:** Version 0.3.0 already published to Test PyPI. Either:
- Use a different version (0.3.1)
- Delete package from Test PyPI (if possible)
- Continue with production

**Problem:** Workflow doesn't trigger on RC tag
**Solution:** Verify tag format:
```bash
# Correct: v0.3.0-RC1
# Wrong: 0.3.0-RC1 (missing 'v')
# Wrong: v0.3.0RC1 (missing dash)
```

### Phase 7 Issues

**Problem:** PyPI publish fails with "403 Forbidden"
**Solution:** Token needs "Entire account" scope for first publish

**Problem:** Package uploads but metadata is wrong
**Solution:** Check pyproject.toml keywords/classifiers, rebuild and re-upload:
```bash
poetry build
poetry publish
```

**Problem:** "Version already exists"
**Solution:** Cannot reuse version numbers on PyPI. Must increment:
```bash
poetry version 0.3.1
git tag v0.3.1
git push origin v0.3.1
```

---

## Post-Release Workflow

After v0.3.0 is published, future releases follow this pattern:

### For Each New Release

1. **Development** (ongoing)
   ```bash
   # Feature work on dev branch
   git checkout dev
   # ... make changes ...
   git commit -m "feat: Add new rule"
   git push origin dev
   ```

2. **Update CHANGELOG** (as you go)
   ```bash
   vim CHANGELOG.md
   # Add entries under ## [Unreleased]
   ```

3. **Prepare Release** (when ready)
   ```bash
   # Tag RC
   git tag v0.3.1-RC1 -m "Release candidate for v0.3.1"
   git push origin v0.3.1-RC1

   # ðŸ¤– Automation runs:
   #   - Updates pyproject.toml
   #   - Transforms CHANGELOG
   #   - Creates PR
   ```

4. **Review and Merge**
   ```bash
   # Review PR, edit CHANGELOG if needed
   # Approve and merge PR
   ```

5. **Tag Production**
   ```bash
   git checkout main
   git pull origin main
   git tag v0.3.1 -m "Release v0.3.1"
   git push origin v0.3.1

   # ðŸ¤– PyPI publish triggers automatically
   ```

6. **Verify**
   ```bash
   # Check PyPI listing
   # Test pip install
   pip install --upgrade ignition-lint
   ```

---

## Appendix A: Quick Reference

### Common Commands

**Build locally:**
```bash
poetry build
```

**Publish to Test PyPI:**
```bash
poetry config repositories.testpypi https://test.pypi.org/legacy/
poetry publish -r testpypi
```

**Publish to production PyPI:**
```bash
poetry publish
```

**Install from Test PyPI:**
```bash
pip install --index-url https://test.pypi.org/simple/ \
    --extra-index-url https://pypi.org/simple/ \
    ignition-lint
```

**Create RC tag:**
```bash
git tag v0.3.1-RC1 -m "Release candidate"
git push origin v0.3.1-RC1
```

**Create production tag:**
```bash
git tag v0.3.1 -m "Release v0.3.1"
git push origin v0.3.1
```

### File Changes Summary

**Modified:**
- `pyproject.toml` - Version, dependencies, metadata
- `CHANGELOG.md` - Release dates, links
- `CLAUDE.md` - Release section added
- `README.md` - PyPI badges (optional)

**Created:**
- `.github/workflows/ci-pipeline.yml` - Renamed from ci.yml
- `.github/workflows/prepare-release.yml` - RC automation
- `.github/workflows/publish.yml` - PyPI publishing
- `RELEASING.md` - Release documentation
- `docs/v0.3.0-pypi-publishing-plan.md` - This plan

**Deleted:**
- `.github/workflows/ci.yml` - Renamed to ci-pipeline.yml
- `.github/workflows/unittest.yml` - Redundant
- `.github/workflows/integration-test.yml` - Redundant

### Workflow Triggers

| Workflow | Triggers | Purpose |
|----------|----------|---------|
| ci-pipeline.yml | PR to main/dev | Test, lint, build |
| prepare-release.yml | Push RC tag (v*-RC*) | Create release PR |
| publish.yml | Push tag (v*) | Publish to PyPI |

### Version Numbering

Follow Semantic Versioning:
- **MAJOR**: Breaking changes (e.g., 1.0.0 â†’ 2.0.0)
- **MINOR**: New features (e.g., 0.3.0 â†’ 0.4.0)
- **PATCH**: Bug fixes (e.g., 0.3.0 â†’ 0.3.1)

---

## Appendix B: Complete RELEASING.md Content

(See separate section or file for full RELEASING.md template)

---

## Success Criteria

### Phase 1
- âœ… Package works without ignition-api-stubs
- âœ… Tests pass on Python 3.13
- âœ… Version bumped to 0.3.0

### Phase 2
- âœ… CI runs only on PRs (not pushes)
- âœ… Tests Python 3.13 for dev PRs
- âœ… Tests all versions for main PRs
- âœ… Redundant workflows deleted

### Phase 3
- âœ… RC tag triggers prepare-release workflow
- âœ… Production tag triggers publish workflow
- âœ… Workflows are idempotent

### Phase 4
- âœ… RELEASING.md documents process
- âœ… CLAUDE.md references release workflow

### Phase 5
- âœ… PyPI accounts created
- âœ… API tokens generated and secured
- âœ… GitHub secrets configured

### Phase 6
- âœ… Local build succeeds
- âœ… Test PyPI publish works
- âœ… Package installs from Test PyPI
- âœ… RC workflow tested

### Phase 7
- âœ… Package published to PyPI as v0.3.0
- âœ… pip install works
- âœ… GitHub Release created
- âœ… Token scope restricted

---

## Next Steps After v0.3.0

1. Monitor PyPI analytics
2. Gather user feedback
3. Plan v0.4.0 features
4. Consider adding:
   - More CI matrix (OS: ubuntu, macos, windows)
   - More comprehensive pre-commit hooks
   - Documentation site (ReadTheDocs, GitHub Pages)
   - Example projects using ignition-lint

---

**End of Execution Plan**

Ready to start with Phase 1? ðŸš€
